function aleaJactaEst(){return Math.floor(100*Math.random()+1)}function launchGame(){for(var e=[],t=playersList.length-1;t>=0;t--)e[t]=new Player(t,playersList[t].name,playersList[t].color,playersList[t].colorClass);screen.width<=767&&(settings.mapX=11,settings.mapY=14),daGame=new Game(settings.nbPlayers,settings.water,settings.cities,settings.mapX,settings.mapY,e),daGame.newTurn(),game=new Vue({el:"#game",data:daGame,computed:{currentPlayerName:function(){return this.players[this.currentPlayer].name},daPlayer:function(){return this.players[this.currentPlayer]},rows:function(){return this.board},displayFeature:function(){switch(this.nextSquare.feature){case-1:return"water";case 1:return"glyphicon glyphicon-th";case 2:return"glyphicon glyphicon-cog";default:return""}}},components:{"square-component":{props:{sq:Object},template:"#square-template",data:function(){return this.sq},computed:{isCity:function(){return 1==this.feature?!this.occupied:!1},isHQ:function(){return 2==this.feature?!this.occupied:!1},proba:function(){return daGame.estimateDifficulty(this.y,this.x)},ownerColorClass:function(){return-1==this.feature?"water":this.supplied?daGame.players[this.owner].colorClass:daGame.players[this.owner].colorClass+" unsupplied"},methods:{sqAction:function(){daGame.squareAction(this.row,this.col)}}}}}})}function endTurn(){daGame.endTurn()}var Player=function(e,t,r,s){this.id=e,this.name=t,this.color=r,this.colorClass=s,this.nbCities=0,this.nbRsv=0,0===e?this.alive=!1:this.alive=!0},Game=function(e,t,r,s,a,i){this.nbPlayers=e,this.currentPlayer=1,this.players=i,this.mapX=s,this.mapY=a,this.board=this.generateMap(s,a,t,r,e),this.mTxt="Welcome to Supply Line",this.mType="success",this.nextSquare=this.board[0][0],this.nextProba=0,this.turn=0};Game.WATER=-1,Game.EMPTY=0,Game.CITY=1,Game.HQ=2,Game.prototype.generateMap=function(e,t,r,s,a){for(var i=[],n=t-1;n>=0;n--){i[n]=[];for(var o=Math.floor((this.mapX-3)/2),u=e-1;u>=0;u--){i[n][u]={owner:0,feature:Game.EMPTY,supplied:!0,occupied:!1,col:u,row:n};var l=aleaJactaEst();if(r>l)i[n][u].feature=Game.WATER;else switch(l>100-s&&(i[n][u].feature=Game.CITY),a){case 2:o>u?i[n][u].owner=1:u>=e-o&&(i[n][u].owner=2);break;case 3:break;case 4:}}}return i[1][1].feature=Game.HQ,i[1][1].owner=1,i[t-2][e-2].feature=Game.HQ,i[t-2][e-2].owner=2,i},Game.prototype.message=function(e,t){this.mTxt=e,this.mType=t},Game.prototype.squareAction=function(e,t){var r=this.board[e][t];if(r.feature===Game.WATER)this.message("Going for a swim?","warning");else if(r.owner===this.currentPlayer)r.supplied?(this.message("",""),r.occupied===!1?this.players[this.currentPlayer].nbRsv>0&&(r.occupied=!0,this.players[this.currentPlayer].nbRsv-=1):(r.occupied=!1,this.players[this.currentPlayer].nbRsv+=1)):this.message("unsupplied territory","warning");else if(this.players[this.currentPlayer].nbRsv>0)if(this.reachableFor(e,t,this.currentPlayer)){this.players[this.currentPlayer].nbRsv-=1;var s=this.estimateDifficulty(r),a=aleaJactaEst();a>s?(r.owner=this.currentPlayer,r.occupied=!0,r.supplied=!0,this.updateSupplies(e,t),r.feature==Game.HQ?this.message("You Won !","success"):this.message("New territory!","success")):this.message("Battle lost","danger")}else this.message("You need to be adjacent to your territories","warning");else this.message("No troups left","warning")},Game.prototype.reachableFor=function(e,t,r){for(var s=this.adjacentCells(e,t),a=s.length-1;a>=0;a--)if(s[a].owner==r&&s[a].supplied)return!0;return!1},Game.prototype.squareOver=function(e,t){this.nextSquare=this.board[e][t],this.nextProba=this.estimateDifficulty(this.board[e][t])},Game.prototype.estimateDifficulty=function(e){if(e.feature==Game.WATER)return 100;if(e.owner==this.currentPlayer)return 0;var t=7;t+=25*e.feature,e.occupied&&(t+=19),0!==e.owner&&(t+=17),e.supplied&&(t+=20);for(var r=this.adjacentCells(e.row,e.col),s=r.length-1;s>=0;s--)r[s].owner==this.currentPlayer&&r[s].supplied&&(t-=7);return Math.max(Math.min(t,99),1)},Game.prototype.adjacentCells=function(e,t){var r=[];return t-1>=0&&this.board[e][t-1].feature>=0&&r.push(this.board[e][t-1]),e+1<this.mapY&&this.board[e+1][t].feature>=0&&r.push(this.board[e+1][t]),t+1<this.mapX&&this.board[e][t+1].feature>=0&&r.push(this.board[e][t+1]),e-1>=0&&this.board[e-1][t].feature>=0&&r.push(this.board[e-1][t]),r},Game.prototype.looseUnsupplied=function(){for(var e=this.mapY-1;e>=0;e--)for(var t=this.mapX-1;t>=0;t--){var r=this.board[e][t];r.owner===this.currentPlayer&&r.supplied===!1&&(r.owner=0,r.supplied=!0,r.occupied=!1)}},Game.prototype.updateSupplies=function(e,t){for(var r=this.adjacentCells(e,t),s=new Array(this.mapY),a=this.mapY-1;a>=0;a--){s[a]=new Array(this.mapX);for(var i=this.mapX-1;i>=0;i--)s[a][i]=-1}for(var n=r.length-1;n>=0;n--)if(-1==s[r[n].row][r[n].col])if(r[n].owner!=this.currentPlayer&&0!=r[n].owner){var o=[];if(this.recursiveReach(r[n],s,o,r[n].owner,n));else for(var u=o.length-1;u>=0;u--)o[u].supplied=!1}else r[n].owner==this.currentPlayer&&0==r[n].supplied&&this.recursiveSupply(r[n],s,this.currentPlayer,n)},Game.prototype.recursiveSupply=function(e,t,r,s){t[e.row][e.col]=s,e.supplied=!0;for(var a=this.adjacentCells(e.row,e.col),i=a.length-1;i>=0;i--)a[i].owner==r&&t[a[i].row][a[i].col]<s&&this.recursiveSupply(a[i],t,r,s)},Game.prototype.recursiveReach=function(e,t,r,s,a){if(t[e.row][e.col]=a,e.feature>0)return!0;r.push(e);for(var i=this.adjacentCells(e.row,e.col),n=i.length-1;n>=0;n--)if(i[n].owner==s){if(t[i[n].row][i[n].col]>a)return i[n].supplied;if(-1==t[i[n].row][i[n].col]&&this.recursiveReach(i[n],t,r,s,a))return!0}return!1},Game.prototype.countCities=function(e){this.players[e].nbCities=0;for(var t=this.mapY-1;t>=0;t--)for(var r=this.mapX-1;r>=0;r--)this.board[t][r].owner==e&&this.board[t][r].feature==Game.CITY&&(this.players[e].nbCities+=1)},Game.prototype.changePlayer=function(){this.currentPlayer>=this.nbPlayers?this.currentPlayer=1:this.currentPlayer=this.currentPlayer+1},Game.prototype.endTurn=function(){this.looseUnsupplied(),this.changePlayer(),this.turn++,this.newTurn()},Game.prototype.newTurn=function(){this.countCities(this.currentPlayer),this.turn>=this.nbPlayers?this.players[this.currentPlayer].nbRsv+=2+Math.floor(this.players[this.currentPlayer].nbCities/3):this.players[this.currentPlayer].nbRsv+=Math.floor(this.mapX/6)+this.turn,this.message("New turn","info")};var daGame,game;window.onload=function(){var e=document.getElementById("bgAudio");e.volume=.1,launchGame()};var settings={nbPlayers:2,water:10,mapX:21,mapY:16,cities:3},playersList=[{name:"Neutral",color:"#333",colorClass:"colorNeutral"},{name:"Lefty",color:"#F34",colorClass:"colorA"},{name:"Righty",color:"#AEC",colorClass:"colorB"}];