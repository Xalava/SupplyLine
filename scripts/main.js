function aleaJactaEst(){return Math.floor(100*Math.random()+1)}function launchGame(){for(var e=[],r=playersList.length-1;r>=0;r--)e[r]=new Player(r,playersList[r].name,playersList[r].color,playersList[r].colorClass);daGame=new Game(settings.nbPlayers,settings.water,settings.cities,settings.mapX,settings.mapY,e,settings.squareSize),console.log(daGame),daGame.newTurn(),game=new Vue({el:"#game",data:daGame,computed:{currentPlayerName:function(){return this.players[this.currentPlayer].name},daPlayer:function(){return this.players[this.currentPlayer]},mapWidth:function(){return this.mapX*this.squareSize},mapHeight:function(){return this.mapY*this.squareSize},squarelocation:function(){return this.mapY*this.squareSize},squares:function(){return this.board.reduce(function(e,r){return e.concat(r)})},rows:function(){return this.board}},components:{"square-component":{props:{sq:Object},template:"#square-template",data:function(){return this.sq},computed:{isCity:function(){return 1==this.feature?!this.occupied:!1},isHQ:function(){return 2==this.feature?!this.occupied:!1},proba:function(){return daGame.estimateDifficulty(this.y,this.x)},diplayFeature:function(){},ownerColorClass:function(){return-1==this.feature?"water":this.supplied?daGame.players[this.owner].colorClass:daGame.players[this.owner].colorClass+" unsupplied"},methods:{sqAction:function(){daGame.squareAction(this.boardCol,this.boardRow)}}}}}})}function endTurn(){daGame.endTurn()}var Player=function(e,r,t,a){this.id=e,this.name=r,this.color=t,this.colorClass=a,this.nbCities=0,this.nbRsv=5,0===e?this.alive=!1:this.alive=!0},Game=function(e,r,t,a,s,o,i){this.nbPlayers=e,this.currentPlayer=1,this.players=o,this.mapX=a,this.mapY=s,this.squareSize=i,this.board=this.generateMap(a,s,r,t,i,e),this.mTxt="Welcome to Supply Line",this.mType="success",this.nextSquare=this.board[0][0],this.nextProba=0,console.log("game created")};Game.WATER=-1,Game.EMPTY=0,Game.CITY=1,Game.HQ=2,Game.prototype.generateMap=function(e,r,t,a,s,o){for(var i=[],n=r-1;n>=0;n--){i[n]=[];for(var u=e-1;u>=0;u--){i[n][u]={owner:0,feature:0,supplied:!0,isChecked:!1,isDone:!1,occupied:!1,boardCol:u,boardRow:n,x:u*s,y:n*s};var l=aleaJactaEst();if(t>l)i[n][u].feature=-1;else switch(l>100-a&&(i[n][u].feature=1),o){case 2:var c=Math.floor(48*this.mapX/100);c>u?i[n][u].owner=1:u>e-c&&(i[n][u].owner=2);break;case 3:break;case 4:}}}return i[1][1].feature=Game.HQ,i[1][1].owner=1,i[r-2][e-2].feature=Game.HQ,i[r-2][e-2].owner=2,i},Game.prototype.message=function(e,r){this.mTxt=e,this.mType=r},Game.prototype.squareAction=function(e,r){var t=this.board[r][e];if(t.feature===Game.WATER)this.message("Going for a swim?","warning");else if(t.owner===this.currentPlayer)t.supplied?(this.message("",""),t.occupied===!1?this.players[this.currentPlayer].nbRsv>0&&(t.occupied=!0,this.players[this.currentPlayer].nbRsv-=1):(t.occupied=!1,this.players[this.currentPlayer].nbRsv+=1)):this.message("unsupplied territory","warning");else if(this.players[this.currentPlayer].nbRsv>0)if(this.reachableFor(r,e,this.currentPlayer)){var a=this.estimateDifficulty(t);a<aleaJactaEst()?(t.owner=this.currentPlayer,t.occupied=!0,t.supplied=!0,this.updateSupplies(r,e),t.feature==Game.HQ?this.message("You Won !","success"):this.message("New territory!","success")):this.message("Battle lost","warning"),this.players[this.currentPlayer].nbRsv-=1}else this.message("You need to be adjacent to your territories","warning");else this.message("No troups left","warning")},Game.prototype.reachableFor=function(e,r,t){for(var a=this.adjacentCells(e,r),s=a.length-1;s>=0;s--)if(a[s].owner==t&&a[s].supplied)return!0;return!1},Game.prototype.squareOver=function(e,r){this.nextSquare=this.board[e][r],this.nextProba=this.estimateDifficulty(this.board[e][r])},Game.prototype.estimateDifficulty=function(e){if(e.feature==Game.WATER)return 100;if(e.owner==this.currentPlayer)return 0;var r=5;r+=20*e.feature,e.occupied&&(r+=20),0!==e.owner&&(r+=18),e.supplied&&(r+=16);for(var t=this.adjacentCells(e.boardRow,e.boardCol),a=t.length-1;a>=0;a--)t[a].owner==this.currentPlayer&&t[a].supplied&&(r-=5);return r},Game.prototype.adjacentCells=function(e,r){var t=[];return r-1>=0&&this.board[e][r-1].feature>=0&&t.push(this.board[e][r-1]),e+1<this.mapY&&-1!=this.board[e+1][r].feature&&t.push(this.board[e+1][r]),r+1<this.mapX&&-1!=this.board[e][r+1].feature&&t.push(this.board[e][r+1]),e-1>=0&&-1!=this.board[e-1][r].feature&&t.push(this.board[e-1][r]),t},Game.prototype.looseUnsupplied=function(){for(var e=this.mapY-1;e>=0;e--)for(var r=this.mapX-1;r>=0;r--){var t=this.board[e][r];t.owner===this.currentPlayer&&t.supplied===!1&&(t.owner=0,t.supplied=!0,t.occupied=!1)}},Game.prototype.updateSupplies=function(e,r){for(var t=this.adjacentCells(e,r),a=new Array(this.mapY),s=this.mapY-1;s>=0;s--){a[s]=new Array(this.mapX);for(var o=this.mapX-1;o>=0;o--)a[s][o]=-1}console.log("# Before for on ",e,r);for(var i=t.length-1;i>=0;i--)if(console.log("----",i),-1==a[t[i].boardRow][t[i].boardCol])if(t[i].owner!=this.currentPlayer&&0!=t[i].owner){var n=[];if(this.recursiveReach(t[i],a,n,t[i].owner,i));else{console.log("unsupplies from ",t[i].boardRow,t[i].boardCol);for(var u=n.length-1;u>=0;u--)n[u].supplied=!1}}else t[i].owner==this.currentPlayer&&0==t[i].supplied&&this.recursiveSupply(t[i],a,this.currentPlayer,i);else console.log(t[i].boardRow,t[i].boardCol,"was already checked")},Game.prototype.recursiveSupply=function(e,r,t,a){console.log("Supply Supply on ",e.boardRow,e.boardCol," with run ",a),r[e.boardRow][e.boardCol]=a,e.supplied=!0;for(var s=this.adjacentCells(e.boardRow,e.boardCol),o=s.length-1;o>=0;o--)s[o].owner==t&&r[s[o].boardRow][s[o].boardCol]<a&&this.recursiveSupply(s[o],r,t,a)},Game.prototype.recursiveReach=function(e,r,t,a,s){if(r[e.boardRow][e.boardCol]=s,console.log("Recursion on ",e.boardRow,e.boardCol," with run ",s),e.feature>0)return!0;t.push(e);for(var o=this.adjacentCells(e.boardRow,e.boardCol),i=o.length-1;i>=0;i--)if(o[i].owner==a){if(r[o[i].boardRow][o[i].boardCol]>s)return console.log("visited in a prior run with positive value"),o[i].supplied;if(-1==r[o[i].boardRow][o[i].boardCol]&&this.recursiveReach(o[i],r,t,a,s))return console.log("break ",e.boardRow,e.boardCol,"with TRUE"),!0}return!1},Game.prototype.countCities=function(e){this.players[e].nbCities=0;for(var r=this.mapY-1;r>=0;r--)for(var t=this.mapX-1;t>=0;t--)this.board[r][t].owner==e&&this.board[r][t].feature==Game.CITY&&(this.players[e].nbCities+=1)},Game.prototype.changePlayer=function(){this.currentPlayer>=this.nbPlayers?this.currentPlayer=1:this.currentPlayer=this.currentPlayer+1,this.players[this.currentPlayer].nbRsv+=3},Game.prototype.endTurn=function(){this.looseUnsupplied(),this.changePlayer(),this.newTurn()},Game.prototype.newTurn=function(){this.message("New turn","info"),console.log("New turn of ",this.currentPlayer),this.countCities(this.currentPlayer)},console.log("Supply Line on the console");var daGame,game;window.onload=function(){var e=document.getElementById("bgAudio");e.volume=.1,launchGame()};var settings={nbPlayers:2,water:10,squareSize:25,mapX:20,mapY:16,cities:3},playersList=[{name:"Neutral",color:"#333",colorClass:"colorNeutral"},{name:"Lefty",color:"#F34",colorClass:"colorA"},{name:"Righty",color:"#AEC",colorClass:"colorB"}];